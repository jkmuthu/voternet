<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>VoterNet - Voter Dashboard</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f3f4f6;
            color: #1f2937;
            padding: 20px;
        }
        .container { max-width: 1100px; margin: 0 auto; }
        .header {
            background: #fff;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }
        .title { color: #4338ca; font-size: 28px; font-weight: 800; }
        .btn {
            border: none;
            border-radius: 8px;
            padding: 9px 12px;
            cursor: pointer;
            font-weight: 700;
            text-decoration: none;
            display: inline-block;
        }
        .btn-primary { background: #4f46e5; color: white; }
        .btn-light { background: #e5e7eb; color: #111827; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 12px; margin-bottom: 16px; }
        .card {
            background: #fff;
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.06);
            border: 1px solid #e5e7eb;
        }
        .card h3 { color: #4338ca; margin-bottom: 8px; }
        .muted { color: #6b7280; font-size: 14px; }
        .list-item {
            border: 1px solid #e5e7eb;
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 10px;
            background: #fff;
        }
        .badge {
            display: inline-block;
            font-size: 12px;
            background: #eef2ff;
            color: #4338ca;
            border-radius: 999px;
            padding: 3px 8px;
            font-weight: 700;
        }
        .warn {
            background: #fff7ed;
            border: 1px solid #fed7aa;
            color: #9a3412;
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="title">üë• Voter Dashboard</div>
            <div>
                <a class="btn btn-light" href="/index.html">Home</a>
                <a class="btn btn-light" href="/civic/feed">Civic Feed</a>
                <a class="btn btn-primary" href="/vote.html">Vote Now</a>
            </div>
        </div>

        <div id="roleNote" style="display:none;" class="warn"></div>

        <div class="grid" id="summaryGrid">
            <div class="card"><h3>Profile</h3><p id="profileName" class="muted">Loading...</p></div>
            <div class="card"><h3>Role</h3><p id="profileRole" class="muted">-</p></div>
            <div class="card"><h3>Active Elections</h3><p id="activeCount" class="muted">-</p></div>
            <div class="card"><h3>Recent Civic Posts</h3><p id="postCount" class="muted">-</p></div>
        </div>

        <div class="card" style="margin-bottom: 16px;">
            <h3>üó≥Ô∏è Active Elections</h3>
            <div id="electionsList" class="muted">Loading elections...</div>
        </div>

        <div class="card">
            <h3>üì∞ Community Highlights</h3>
            <div id="postsList" class="muted">Loading posts...</div>
        </div>
    </div>

    <script src="config.js"></script>
    <script>
        const token = localStorage.getItem('token') || localStorage.getItem('accessToken');

        function escapeHtml(value) {
            return String(value || '')
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }

        async function secureFetch(path, options = {}) {
            const headers = options.headers || {};
            if (token) headers['Authorization'] = `Bearer ${token}`;
            const res = await fetch(`${API_URL}${path}`, { ...options, headers });
            const data = await res.json().catch(() => ({}));
            if (!res.ok) throw new Error(data.message || 'Request failed');
            return data;
        }

        async function loadDashboard() {
            if (!token) {
                window.location.href = '/index.html#auth';
                return;
            }

            try {
                const [profile, elections, posts] = await Promise.all([
                    secureFetch('/users/me'),
                    fetch(`${API_URL}/api/elections/active`).then((r) => r.json()),
                    fetch(`${API_URL}/api/civic/posts?limit=5&page=1`).then((r) => r.json())
                ]);

                document.getElementById('profileName').textContent = `${profile.firstName} ${profile.lastName}`;
                document.getElementById('profileRole').textContent = profile.role;
                document.getElementById('activeCount').textContent = String((elections.data || []).length);
                document.getElementById('postCount').textContent = String((posts.posts || []).length);

                const roleNote = document.getElementById('roleNote');
                if (profile.role !== 'voter') {
                    roleNote.style.display = 'block';
                    roleNote.textContent = `You are logged in as '${profile.role}'. Voter dashboard is still available for civic monitoring.`;
                }

                const electionItems = elections.data || [];
                const electionsList = document.getElementById('electionsList');
                electionsList.innerHTML = electionItems.length
                    ? electionItems.map((e) => `
                        <div class="list-item">
                            <span class="badge">${escapeHtml(e.electionType)}</span>
                            <h4 style="margin: 8px 0;">${escapeHtml(e.title)}</h4>
                            <p class="muted">Ends: ${new Date(e.endDate).toLocaleString()}</p>
                        </div>
                    `).join('')
                    : '<p class="muted">No active elections right now.</p>';

                const postItems = posts.posts || [];
                const postsList = document.getElementById('postsList');
                postsList.innerHTML = postItems.length
                    ? postItems.map((p) => `
                        <div class="list-item">
                            <span class="badge">${escapeHtml(p.postType)}</span>
                            <h4 style="margin: 8px 0;">${escapeHtml(p.title)}</h4>
                            <p class="muted">${escapeHtml((p.content || '').slice(0, 160))}${(p.content || '').length > 160 ? '...' : ''}</p>
                        </div>
                    `).join('')
                    : '<p class="muted">No civic posts found.</p>';
            } catch (error) {
                document.getElementById('summaryGrid').innerHTML = `<div class="warn">${error.message}</div>`;
                document.getElementById('electionsList').innerHTML = '<p class="muted">Unable to load elections.</p>';
                document.getElementById('postsList').innerHTML = '<p class="muted">Unable to load posts.</p>';
            }
        }

        loadDashboard();
    </script>
</body>
</html>
